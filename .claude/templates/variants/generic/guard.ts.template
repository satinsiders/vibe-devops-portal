/**
 * {{GUARD_NAME}} Guard
 *
 * {{GUARD_DESCRIPTION}}
 *
 * @example
 * ```typescript
 * // Express middleware
 * app.get('/protected', {{GUARD_NAME}}Guard, handler);
 *
 * // Next.js API route
 * export default with{{GUARD_NAME}}(handler);
 *
 * // React hook
 * const { isAllowed, isLoading } = use{{GUARD_NAME}}Guard();
 * ```
 *
 * Template Placeholders:
 * - {{GUARD_NAME}}: PascalCase guard name (e.g., Auth, Admin, RateLimit)
 * - {{GUARD_DESCRIPTION}}: Brief description of what this guard protects
 * - {{GUARD_CONDITION}}: The condition to check (e.g., user.role === 'admin')
 * - {{GUARD_ERROR_MESSAGE}}: Error message when guard fails
 */

import type { NextRequest, NextResponse } from 'next/server';
import type { Request, Response, NextFunction } from 'express';

// =============================================================================
// Types
// =============================================================================

export interface {{GUARD_NAME}}GuardContext {
  /**
   * The authenticated user (if any)
   */
  user?: {
    id: string;
    email: string;
    role: string;
    // Add more user properties as needed
  };
  /**
   * The original request
   */
  request: Request | NextRequest;
}

export interface {{GUARD_NAME}}GuardResult {
  /**
   * Whether access is allowed
   */
  allowed: boolean;
  /**
   * Reason for denial (if not allowed)
   */
  reason?: string;
  /**
   * HTTP status code to return (if not allowed)
   */
  statusCode?: number;
}

// =============================================================================
// Guard Logic
// =============================================================================

/**
 * Core guard logic - checks if access should be allowed
 */
export async function check{{GUARD_NAME}}(
  context: {{GUARD_NAME}}GuardContext
): Promise<{{GUARD_NAME}}GuardResult> {
  const { user } = context;

  // Check if user is authenticated
  if (!user) {
    return {
      allowed: false,
      reason: 'Authentication required',
      statusCode: 401,
    };
  }

  // {{GUARD_CONDITION}} - Replace with actual condition
  const isAllowed = user.role === 'admin'; // Example condition

  if (!isAllowed) {
    return {
      allowed: false,
      reason: '{{GUARD_ERROR_MESSAGE}}',
      statusCode: 403,
    };
  }

  return { allowed: true };
}

// =============================================================================
// Express Middleware
// =============================================================================

/**
 * Express middleware guard
 *
 * @example
 * ```typescript
 * app.get('/admin', {{GUARD_NAME}}Guard, (req, res) => {
 *   res.json({ message: 'Welcome, admin!' });
 * });
 * ```
 */
export async function {{GUARD_NAME}}Guard(
  req: Request,
  res: Response,
  next: NextFunction
): Promise<void> {
  try {
    const result = await check{{GUARD_NAME}}({
      user: (req as any).user, // Assumes auth middleware has attached user
      request: req,
    });

    if (!result.allowed) {
      res.status(result.statusCode || 403).json({
        error: {
          code: '{{GUARD_NAME}}_DENIED'.toUpperCase(),
          message: result.reason || 'Access denied',
        },
      });
      return;
    }

    next();
  } catch (error) {
    console.error('{{GUARD_NAME}}Guard error:', error);
    res.status(500).json({
      error: {
        code: 'INTERNAL_ERROR',
        message: 'An error occurred while checking permissions',
      },
    });
  }
}

// =============================================================================
// Next.js API Route Wrapper
// =============================================================================

type NextApiHandler = (
  request: NextRequest
) => Promise<NextResponse> | NextResponse;

/**
 * Next.js API route guard wrapper
 *
 * @example
 * ```typescript
 * export const GET = with{{GUARD_NAME}}(async (req) => {
 *   return NextResponse.json({ message: 'Protected data' });
 * });
 * ```
 */
export function with{{GUARD_NAME}}(handler: NextApiHandler): NextApiHandler {
  return async (request: NextRequest) => {
    try {
      // Get user from session/token (implement based on your auth system)
      const user = await getUserFromRequest(request);

      const result = await check{{GUARD_NAME}}({
        user,
        request,
      });

      if (!result.allowed) {
        return NextResponse.json(
          {
            error: {
              code: '{{GUARD_NAME}}_DENIED'.toUpperCase(),
              message: result.reason || 'Access denied',
            },
          },
          { status: result.statusCode || 403 }
        );
      }

      return handler(request);
    } catch (error) {
      console.error('with{{GUARD_NAME}} error:', error);
      return NextResponse.json(
        {
          error: {
            code: 'INTERNAL_ERROR',
            message: 'An error occurred while checking permissions',
          },
        },
        { status: 500 }
      );
    }
  };
}

// =============================================================================
// React Hook
// =============================================================================

/**
 * React hook for client-side guard checks
 *
 * @example
 * ```tsx
 * function ProtectedComponent() {
 *   const { isAllowed, isLoading } = use{{GUARD_NAME}}Guard();
 *
 *   if (isLoading) return <Spinner />;
 *   if (!isAllowed) return <AccessDenied />;
 *
 *   return <ProtectedContent />;
 * }
 * ```
 */
export function use{{GUARD_NAME}}Guard(): {
  isAllowed: boolean;
  isLoading: boolean;
  error: Error | null;
} {
  // Implementation depends on your auth context/provider
  // This is a placeholder - implement based on your auth system

  // Example with a hypothetical useAuth hook:
  // const { user, isLoading } = useAuth();
  //
  // if (isLoading) {
  //   return { isAllowed: false, isLoading: true, error: null };
  // }
  //
  // const isAllowed = user?.role === 'admin'; // {{GUARD_CONDITION}}
  //
  // return { isAllowed, isLoading: false, error: null };

  return {
    isAllowed: false,
    isLoading: true,
    error: null,
  };
}

// =============================================================================
// Helper Functions
// =============================================================================

/**
 * Extract user from request (implement based on your auth system)
 */
async function getUserFromRequest(
  request: NextRequest
): Promise<{{GUARD_NAME}}GuardContext['user'] | undefined> {
  // Implementation depends on your auth system
  // Examples:
  // - JWT: decode token from Authorization header
  // - Session: look up session from cookie
  // - NextAuth: use getServerSession

  const authHeader = request.headers.get('authorization');
  if (!authHeader?.startsWith('Bearer ')) {
    return undefined;
  }

  // Decode and verify token (implement your logic)
  // const token = authHeader.slice(7);
  // const user = await verifyToken(token);

  return undefined;
}

// =============================================================================
// Default Export
// =============================================================================

export default {{GUARD_NAME}}Guard;
